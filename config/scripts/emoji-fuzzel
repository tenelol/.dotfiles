#!/usr/bin/env bash
set -euo pipefail

PATH="/run/current-system/sw/bin:/etc/profiles/per-user/$USER/bin:/nix/var/nix/profiles/per-user/$USER/profile/bin:$HOME/.nix-profile/bin:$HOME/.local/state/nix/profiles/profile/bin:$HOME/.local/bin:$PATH"

emoji_file=""
for candidate in \
  "${UNICODE_EMOJI_FILE:-}" \
  "/run/current-system/sw/share/unicode/emoji/emoji-test.txt" \
  "/etc/profiles/per-user/$USER/share/unicode/emoji/emoji-test.txt" \
  "/nix/var/nix/profiles/per-user/$USER/profile/share/unicode/emoji/emoji-test.txt" \
  "$HOME/.nix-profile/share/unicode/emoji/emoji-test.txt" \
  "$HOME/.local/state/nix/profiles/profile/share/unicode/emoji/emoji-test.txt"
do
  if [[ -n "$candidate" && -f "$candidate" ]]; then
    emoji_file="$candidate"
    break
  fi
done

if [[ -z "$emoji_file" ]]; then
  shopt -s nullglob
  for candidate in \
    /nix/store/*-unicode-emoji-*/share/unicode/emoji/emoji-test.txt \
    /nix/store/*-unicode-emoji-test-*/share/unicode/emoji/emoji-test.txt
  do
    if [[ -f "$candidate" ]]; then
      emoji_file="$candidate"
      break
    fi
  done
  shopt -u nullglob
fi

if [[ -z "$emoji_file" ]]; then
  echo "emoji-fuzzel: emoji-test.txt not found" >&2
  exit 1
fi

selection="$(
  awk -F '# ' '/; fully-qualified/ {
    split($2, parts, " ");
    emoji = parts[1];
    desc = "";
    for (i = 2; i <= length(parts); i++) {
      desc = desc (desc ? " " : "") parts[i];
    }
    print emoji " " desc;
  }' "$emoji_file" | fuzzel --dmenu
)"

if [[ -z "$selection" ]]; then
  exit 0
fi

emoji="${selection%% *}"
wtype -- "$emoji"
